<!DOCTYPE html>
<html lang="en"></html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gift Poll</title>
    <link rel="stylesheet" href="View/css/gift-poll.css"> <!-- Добавете CSS файл, ако имате -->
</head>
<body>
    <div class="poll-management">
        <!-- Бутон за създаване на Gift Poll -->
        <?php if (!$hasPoll && !$pollEnded): ?> <!-- $hasPoll идва от PHP и казва дали има активен poll -->
            <button id="create-poll-btn">Create Gift Poll</button>
        <?php endif; ?>

        <div class="gift-poll" style="<?= ($hasPoll && !$pollEnded) ? 'display: block;' : 'display: none;' ?>">
            <h1>Gift Poll</h1>

            <div class="add-gift">
                <h2>Add a Gift</h2>
                <form id="add-gift-form">
                    <input type="hidden" name="eventId" id="eventId" value="<?= $eventId ?>">
                    <label for="gift_name">Gift Name:</label>
                    <input type="text" id="gift_name" name="gift_name" required>
                    <label for="gift_price">Gift Price:</label>
                    <input type="number" id="gift_price" name="gift_price" step="0.50" required>
                    <button type="submit">Add Gift</button>
                </form>
                <div id="add-gift-feedback"></div> <!-- Промяна на ID -->
            </div>

            <!-- List of gifts -->
            <div class="gifts">
                <h2>Vote for Your Favorite Gift</h2>
                <ul id="gift-list">
                    <?php foreach ($gifts as $gift): ?>
                        <li data-gift-id="<?= $gift['id'] ?>">
                            <strong><?= htmlspecialchars($gift['gift_name']) ?>:</strong> $<?= htmlspecialchars($gift['gift_price']) ?>
                            <button 
                                class="vote-button"
                                <?= $userVote && $userVote['gift_id'] == $gift['id'] ? 'disabled' : '' ?>>
                                <?= $userVote && $userVote['gift_id'] == $gift['id'] ? 'Voted' : 'Vote' ?>
                            </button>
                        </li>
                    <?php endforeach; ?>
                </ul>
            </div>


        </div>

        <button id="end-poll-btn" style="display: <?= ($hasPoll && !$pollEnded) ? 'block' : 'none' ?>;" >End Poll</button>

    </div>

    <!-- Winner section -->
    <div class="winner-section" style="display: <?= ($pollEnded) ? 'block' : 'none' ?>;">
        <h2>Winning Gift</h2>
        <p id="winning-gift-message">
            <?= isset($winningGift) ? "Winning gift: {$winningGift['gift_name']}, Price: \${$winningGift['gift_price']}, Votes: {$winningGift['vote_count']}" : "" ?>
        </p>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const addGiftForm = document.getElementById("add-gift-form");
            const giftList = document.getElementById("gift-list");
            const feedback = document.getElementById("add-gift-feedback");

            // Add gift
            addGiftForm.addEventListener("submit", (e) => {
                e.preventDefault();
                const formData = new FormData(addGiftForm);

                fetch("/add-gift", {
                    method: "POST",
                    body: formData,
                })
                .then((response) => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then((data) => {
                    if (data.status === "success") {
                        feedback.textContent = data.message;
                        feedback.style.color = "green";
                        console.log(data); 

                        const { id, gift_name, gift_price } = data.gift;

                        // Dynamically add the new gift to the gift list
                        const newGift = document.createElement("li");
                        newGift.setAttribute("data-gift-id", id);
                        newGift.innerHTML = `
                            <strong>${gift_name}:</strong> $${gift_price}
                            <button class="vote-button">Vote</button>
                        `;

                        giftList.appendChild(newGift);

                        // Clear the form fields
                        addGiftForm.reset();
                    } else {
                        feedback.textContent = `Failed to add gift: ${data.message}`;
                        feedback.style.color = "red";
                    }
                })
                .catch((error) => {
                    console.error("Error:", error);
                    feedback.textContent = `An error occurred: ${error.message}`;
                    feedback.style.color = "red";
                });
            });

             // Vote for a gift
            giftList.addEventListener("click", (e) => {
                if (e.target.classList.contains("vote-button")) {
                    const giftId = e.target.closest("li").dataset.giftId;
                    console.log("Send gift id: " + giftId);

                    fetch("/vote-gift", {
                        method: "POST",
                        body: JSON.stringify({ giftId }),
                        headers: { "Content-Type": "application/json" },
                    })
                    .then((response) => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then((data) => {
                        if (data.status === "success") {
                           // Обнови бутоните
                            const allVoteButtons = document.querySelectorAll(".vote-button");
                            allVoteButtons.forEach(button => {
                                button.textContent = "Vote";
                                button.disabled = false;
                            });

                            // Деактивирай текущия бутон
                            e.target.textContent = "Voted";
                            e.target.disabled = true;
                        } else {
                            alert(`Error: ${data.message}`);
                        }
                    })
                    .catch((error) => {
                        console.error("Error:", error);
                    });
                }
            });

        });
        
        //Poll
        document.addEventListener("DOMContentLoaded", () => {
            const createPollBtn = document.getElementById("create-poll-btn");
            const giftPollSection = document.querySelector(".gift-poll");
            const endPollButton = document.getElementById("end-poll-btn");

            if (createPollBtn) {
                createPollBtn.addEventListener("click", () => {
                    const duration = 10;

                    fetch("/create-poll", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ eventId: eventId, duration: duration }),
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === "success") {
                            createPollBtn.style.display = "none";
                            giftPollSection.style.display = "block";
                            endPollButton.style.display = "block";
                        } else {
                            alert(`Error creating poll: ${data.message}`);
                        }
                    })
                    .catch(error => {
                        console.error("Error:", error);
                    });
                });
            }
        });

        //End poll
        document.addEventListener("DOMContentLoaded", () => {
            const endPollBtn = document.getElementById("end-poll-btn");
            const giftPollSection = document.querySelector(".gift-poll");
            const winnerSection = document.querySelector(".winner-section");
            const winningGiftMessage = document.getElementById("winning-gift-message");

            if (endPollBtn) {
                endPollBtn.addEventListener("click", () => {
                    if (!confirm("Are you sure you want to end the poll?")) {
                        return;
                    }

                    fetch("/end-poll", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ eventId: eventId }),
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === "success") {
                            // Скриване на gift poll секцията
                            giftPollSection.style.display = "none";
                            endPollBtn.style.display = "none";
                            console.log(data);
                            // Показване на победителя
                            winnerSection.style.display = "block";
                            const { gift_name, gift_price, vote_count } = data.winner;
                            winningGiftMessage.textContent = `
                                Winning gift: ${gift_name}, Price: $${gift_price}, Votes: ${vote_count}
                            `;
                        } else {
                            alert(`Error ending poll: ${data.message}`);
                        }
                    })
                    .catch(error => {
                        console.error("Error:", error);
                    });
                });
            }
        });


    </script>
</body>
</html>