<?php
$userId = $_SESSION['userId'] ?? '';
$username = $_SESSION['username'] ?? '';
?>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Dashboard</title>
    <link rel="stylesheet" href="/View/css/base-styles.css">
    <link rel="stylesheet" href="/View/css/dashboard-styles.css">
    <link rel="stylesheet" href="/View/css/event_dashboard_styles.css">
</head>
<body>

<!-- Navigation Sidebar -->
<nav class="nav">
    <div class="logo-section">
        <a class="logo-href" href="/">
            <h1>Event Organizer</h1>
        </a>
    </div>
    <div class="nav-buttons">
        <a href="/events"><button>Manage Events</button></a>
        <a href="/search"><button>Search</button></a>
        <a href="/edit"><button>Edit Profile</button></a>
        <a href="/about"><button>About Us</button></a>
        <a href="/logout"><button>Logout</button></a>
        <a href="/delete-acc"><button>Delete Profile</button></a>
    </div>
</nav>

<!-- Main Content -->
<main class="dashboard-main">
    <div class="dashboard">
        <!-- Left Panel: Event Details -->
        <div class="left-panel">
            <h1>Event Details</h1>
            <p><strong>Title:</strong> <?= htmlspecialchars($event->getTitle()) ?></p>
            <p><strong>Date:</strong> <?= htmlspecialchars($event->getEventDate()) ?></p>
            <p><strong>Type:</strong> <?= htmlspecialchars($event->getType()) ?></p>

            <?php if ($event->getHasOrganization()): ?>
                <h2>Organization Details</h2>

                <?php if (!$isParticipant): ?>
                    <form action="/join-event-btn" method="POST" id="join-event-form">
                        <input type="hidden" name="eventId" value="<?= htmlspecialchars($eventId) ?>">
                        <input type="hidden" name="userId" value="<?= htmlspecialchars($userId) ?>">
                        <button type="submit" aria-label="Join Event Organization">Join Event Organization</button>
                    </form>
                <?php else: ?>
                    <p><strong>Organizer:</strong> <?= htmlspecialchars($organizerName) ?></p>
                    <p><strong>Location:</strong> <?= htmlspecialchars($organization['place_address']) ?></p>
                    <h2>Participants</h2>
                    <ul>
                        <?php foreach ($participants as $participant): ?>
                            <li><?= htmlspecialchars($participant) ?></li>
                        <?php endforeach; ?>
                    </ul>

                    <!-- Poll Management -->
                    <div class="poll-management">
                        <?php if (!$hasPoll && !$pollEnded): ?>
                            <button id="create-poll-btn" aria-label="Create Gift Poll">Create Gift Poll</button>
                        <?php endif; ?>

                        <?php if ($hasPoll && !$pollEnded): ?>
                            <div class="gift-poll">
                                <h2>Vote for a Gift</h2>
                                <ul>
                                    <?php foreach ($gifts as $gift): ?>
                                        <li>
                                            <strong><?= htmlspecialchars($gift['gift_name']) ?>:</strong> $<?= htmlspecialchars($gift['gift_price']) ?>
                                            <button class="vote-button" <?= $userVote && $userVote['gift_id'] == $gift['id'] ? 'disabled' : '' ?>>
                                                <?= $userVote && $userVote['gift_id'] == $gift['id'] ? 'Voted' : 'Vote' ?>
                                            </button>
                                        </li>
                                    <?php endforeach; ?>
                                </ul>
                            </div>
                            <button id="end-poll-btn" aria-label="End Poll">End Poll</button>
                        <?php endif; ?>

                        <?php if ($pollEnded): ?>
                            <div class="winner-section">
                                <h2>Winning Gift</h2>
                                <p><?= isset($winningGift) ? "Winning gift: {$winningGift['gift_name']}, Price: \${$winningGift['gift_price']}, Votes: {$winningGift['vote_count']}" : "No winning gift." ?></p>
                                <p><strong>Payment Info:</strong> <?= htmlspecialchars($organization['organizer_payment_details']) ?></p>
                            </div>
                        <?php endif; ?>
                    </div>
                <?php endif; ?>
            <?php else: ?>
                <button id="add-organization-btn" aria-label="Add Organization">Add Organization</button>
                <div id="organization-form-container" style="display: none;">
                    <form id="add-organization-form">
                        <label for="organizer_payment_details">Payment Details:</label>
                        <input type="text" id="organizer_payment_details" name="organizer_payment_details" required>
                        <label for="place_address">Place Address:</label>
                        <input type="text" id="place_address" name="place_address" required>
                        <label for="is_anonymous">Make Anonymous:</label>
                        <input type="checkbox" id="is_anonymous" name="is_anonymous">
                        <button type="submit">Save Organization</button>
                    </form>
                </div>
            <?php endif; ?>

            <form id="delete-event-form" method="POST" action="/delete-event">
                <input type="hidden" name="eventId" value="<?= htmlspecialchars($eventId) ?>">
                <button type="submit" id="delete-event-btn" class="delete-button">Delete Event</button>
            </form>
        </div>

        <!-- Right Panel: Comments -->
        <div class="right-panel">
            <h2>Comments</h2>
            <div id="comments">
                <?php foreach ($comments as $comment): ?>
                    <div class="comment">
                        <p><strong><?= htmlspecialchars($comment->getUsername()) ?>:</strong></p>
                        <p><?= htmlspecialchars($comment->getContent()) ?></p>
                    </div>
                <?php endforeach; ?>
            </div>
            <?php if ($isParticipant): ?>
                <form id="comment-form">
                    <textarea id="new-comment" name="comment" placeholder="Add a comment..." required></textarea>
                    <button type="submit">Submit</button>
                </form>
            <?php endif; ?>
        </div>
    </div>
</main>

<script src="View/js/event_dashboard_js/event_dashboard.js"></script>
<script src="View/js/event_dashboard_js/event_gift_poll.js"></script>
</body>
</html>
